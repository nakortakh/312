# Nginx

## Что такое nginx?
Nginx — это веб-сервер, прокси-сервер, обратный прокси-сервер, smtp-сервер и балансировщик нагрузки.

## Как устроен?
Многие веб-серверы построены на простой многопоточной модели, но NGINX использует событийную архитектуру, которая позволяет ему масштабироваться до сотен тысяч параллельных соединений.
Ключевое — это то, что NGINX обрабатывает множество соединений в одном процессе.

У NGINX есть один мастер-процесс, несколько вспомогательных процессов и worker-процессы.
Основная задача главного процесса — чтение и проверка конфигурации, открытие портов и управление worker-процессами.
Вспомогательные процессы - это cache-менеджер и cache-лоадер.
Worker-процессы выполняют фактическую обработку запросов. 
![Устройство nginx](https://nakortakh.github.io/312/nginx/images/nginx%20how%20to%20work.JPG)

### Процессы и потоки
Процесс или поток — это самодостаточный набор инструкций, который операционная система может запланировать для выполнения на ядре процессора.
С точки зрения ОС процесс и поток это одно и то же, разница лишь в разделении адресного пространства.

На одном ядре одновременно может находиться только один процесс или поток. Процессы на ядре постоянно подменяют друг друга, из-за чего сильно страдает производительность, когда процессов становится много. 
Это камень преткновения для многих современных web-приложений, которые открывают на каждое соединение свой поток.

Многопоточная архитектура легка в реализации, однако плохо масштабируется, когда количество соединений сильно возрастает. 
NGINX использует модель с фиксированным числом процессов, это позволяет максимально эффективно использовать ресурсы сервера.

### Ядро и модули
Nginx состоит из ядра и некоторого количества модулей. 
Ядро nginx отвечает за базовый функционал web-сервера и функционал обратного проксирования web и электронной почты, 
что позволяет предоставлять доступ к реализованным в ядре сетевым протоколам, создавать необходимые среды исполнения и 
обеспечивать "бесшовное" взаимодействие между модулями. 
Тем не менее, большинство функций, специфичных для протоклов и приложений, реализуется модулями, а не ядром.

Nginx сервер не поддерживает динамически загружаемые модули расширения. 
Чтобы добавить модуль к nginx, нужно полностью компилировать nginx из исходных кодов с включенным и статически интегрированным в него новым модулем.

### Иерархия каталогов Nginx
Для анализа работы сервера и ручного внесения изменений в файлы стоит знать расположение и иерархию наиболее важных каталогов:
- `/var/www/html` — начальная страница;
- `/etc/nginx` — директория с основными файлами настроек;
- `etc/nginx/nginx.conf` — главный конфигурационный файл Nginx;
- `/etc/nginx/sites-available` — каталог с конфигурациями для каждого из сайтов, содержащий информацию о них: имя, IP и другое;
- `/etc/nginx/sites-enabled` — в отличие от предыдущей директории, здесь содержатся конфигурации только активных сайтов, которые обслуживаются Nginx;
- `/etc/nginx/snippets` — сниппеты для подключения к основной конфигурации сервера;
- `/var/log/nginx` — директория с логами событий.

## Конфигурирование
Nginx состоит из модулей, которые настраиваются директивами, указанными в конфигурационном файле. 
По умолчанию, конфигурационный файл называется nginx.conf и расположен в каталоге `/usr/local/nginx/conf`, `/etc/nginx` или `/usr/local/etc/nginx`.

NGINX работает с двумя уровнями конфигурационных файлов. 
Первый уровень — глобальный, к нему относится конфигурационный файл `etc/nginx/nginx.conf`. 
Второй уровень — локальный, к нему относятся конфигурационные файлы конкретных сайтов, расположенных, как правило, в `/etc/nginx/site-available` или в `/etc/nginx/conf.d/`

С `nginx.conf` NGINX начинает парсить конфигурационные файлы, которые состоят из директив. 
Директивы могут быть простыми — однострочными, а могут быть блочными. 
Если блочная директива содержит другую вложенную блочную директиву, то такая блочная директива называется контекстом.

Пример простой блочной директивы
```
events {
  worker_connections 1024;
}
```

Пример стандартного контекста
```
server {
    location / {
        root /data/www;
    }

    location /images/ {
        root /data;
    }
}
```
Здесь блочная директива `server` содержит несколько блочных директив `location`, организуя тем самым контекст `server`. Директивы вне любого контекста относятся к main.

Список основных контекстов и их значений:
- `main` — корень конфигурации, по сути это /etc/nginx/nginx.conf;
- `events` — контекст работы с соединениями;
- `http` — контекст работы с http-протоколом;
- `server` — контекст работы с сервером;
- `location` — контекст работы с маршрутизацией запросов.

Контекст может быть указан не явно, а через директиву include c указанием директории расположения. Это делается для экономии места и возможности отдельного изменения параметров директив server. Вот пример, как это может быть исполнено:
```
user www www;
worker_processes 5;
error_log logs/error.log;
pid logs/nginx.pid;
worker_rlimit_nofile 8192;

events {
  worker_connections  4096;
}

http {
  include conf/mime.types;
  include /etc/nginx/sites-enabled/*;
  index index.html index.htm index.php;

  default_type application/octet-stream;
  access_log logs/access.log  main;
  sendfile on;
  tcp_nopush on;
}
```
`include` разворачивает все конфигурационные файлы расположенные в директории `/etc/nginx/sites-enabled/`.

### Формат конфигурационного файла
Конфигурационный файл NGINX состоит из секций. Секции устроены следующим образом:
```
<секция> {
  <директива> <параметры>;
}
```
`;` - Это признак конца строки.

### Глобальные конфигурационные параметры
В глобальной секции задаются параметры, оказывающие влияние на сервер в целом. Его формат отличается от описанного выше. Глобальная секция может включать как конфигурационные директивы, например user и worker_processes, так и секции, например events. Глобальная секция не заключается в фигурные скобки.
Наиболее распространенные глобальные директивы:
- ```user``` - Пользователь и группа, от имени которых исполняются рабочие процессы. Если группа опущена, то подразумевается группа, имя которой совпадает с именем пользователя.
- ```worker_processes``` - Количество рабочих процессов, создаваемых сразу после запуска.
- ```worker_connections``` - Mаксимальное число соединений, одновременно открытых в одном рабочем процессе.
- ```error_log``` - Файл, в который записываются сообщения об ошибках. Если ни в каком другом контексте директивы error_log нет, то в этом файле будут регистрироваться вообще все ошибки.

### Включаемые файлы


### Секция с описанием НТТР-сервера

### Проверка конфигурации Nginx на ошибки
Nginx не читает конфиги на лету, и их можно спокойно править на работающем сервере.
Для проверки конфига nginx на ошибки используйте команду:
```
nginx -c /usr/local/etc/nginx/nginx.conf -t
```
Опция `-t` заставит nginx проверить конфигурационный файл на корректный синтаксис и наличие ошибок, и затем попытается открыть файлы, указанные в конфигурации.
Опция `-c /path/to/config/file` указывает, какой конфигурационный файл nginx должен использовать вместо используемого по-умолчанию.

Для проверки дефолтного конфига использовать команду `nginx -t`.

## Настройка безопасности Nginx
### Заголовки безопасности
- ```add_header X-Frame-Options "SAMEORIGIN";``` - конфигурация, не позволяющая браузеру отображать страницу внутри фрейма или iframe и избегайет кликджекинга http://en.wikipedia.org/wiki/Clickjacking.
- ```add_header X-XSS-Protection "1; mode=block";``` - Этот заголовок включает фильтр межсайтового скриптинга (XSS). Обычно он включен по умолчанию, поэтому роль этого заголовка — повторно включить фильтр для этот конкретного web-сайта, если он был отключен пользователем.
- ```add_header X-Content-Type-Options "nosniff";``` - Заголовок, который сообщает браузеру, чтобы он не пытался угадать (так называемое «MIME sniffing») и интерпретировать тип контента, отличный от того, что указан в заголовке Content-Type.
- ```add_header Strict-Transport-Security "max-age=31536000; includeSubdomains; preload";``` - Домен должен использоваться только через HTTPS. Необязательный параметр includeSubDomains сообщает браузеру, что политика HSTS также распространяется на все поддомены текущего домена.

### Предотвращение DDOS атак
- ```limit_req_zone $binary_remote_addr zone=one:10m rate=30r/m;``` - Для ограничения частоты запросов, отправляемых пользователями в течение нескольких минут.
- ```limit_conn_zone $binary_remote_addr zone=addr:10m;``` - Для ограничения соединений с определенными местоположениями или областями.

### Отключение списка каталогов
- ```auto_index  off;``` - Для предотвращения листинга каталога.

### Разрыв медленных соединений
- ```client_body_timeout``` - Директива задаёт таймаут при чтении тела запроса клиента. Таймаут устанавливается не на всю передачу тела запроса, а только между двумя последовательными операциями чтения. Если по истечении этого времени клиент ничего не передаст, обработка запроса прекращается с ошибкой 408 (Request Time-out).
- ```client_header_timeout``` - Директива задаёт таймаут при чтении заголовка запроса клиента. Если по истечении этого времени клиент не передаст полностью заголовок, обработка запроса прекращается с ошибкой 408 (Request Time-out).
```
server {
    client_body_timeout 5s;
    client_header_timeout 5s;
}
```


## Запуск, остановка, перезагрузка конфигурации
Чтобы запустить nginx, нужно выполнить исполняемый файл. Когда nginx запущен, им можно управлять, вызывая исполняемый файл с параметром `-s`. Используйте следующий синтаксис:
```
nginx -s <сигнал>
```
Где сигнал может быть одним из нижеследующих:
- `stop` — быстрое завершение
- `quit` — плавное завершение с ожиданием окончания обслуживания текущих запросов рабочими процессами
- `reload` — перезагрузка конфигурационного файла
- `reopen` — переоткрытие лог-файлов

Изменения, сделанные в конфигурационном файле, не будут применены, пока команда перезагрузить конфигурацию не будет вручную отправлена nginx’у или он не будет перезапущен. Для перезагрузки конфигурации выполните:
```
nginx -s reload
```
Получив сигнал, главный процесс проверяет правильность синтаксиса нового конфигурационного файла и пытается применить конфигурацию, содержащуюся в нём. Если это ему удаётся, главный процесс запускает новые рабочие процессы и отправляет сообщения старым рабочим процессам с требованием завершиться. В противном случае, главный процесс откатывает изменения и продолжает работать со старой конфигурацией. Старые рабочие процессы, получив команду завершиться, прекращают принимать новые запросы и продолжают обслуживать текущие запросы до тех пор, пока все такие запросы не будут обслужены. После этого старые рабочие процессы завершаются.

## Windows
Версия nginx под Windows использует “родной” Win32 API (не эмуляцию Cygwin). В настоящий момент в качестве методов обработки соединений используются select() и poll() (1.15.9), поэтому не стоит ожидать высокой производительности и масштабируемости. В силу этого и ряда других известных проблем версия nginx под Windows рассматривается пока как бета-версия.

## Nginx UI
Для удобства администрирования nginx сервера существует open source проект Nginx UI.  
[Nginx UI](https://nginxui.com/) — это комплексный веб-интерфейс, разработанный для упрощения управления и настройки серверов Nginx. 
Он предлагает статистику сервера в реальном времени, автоматическое обновление сертификатов Let's Encrypt и удобные инструменты редактирования для конфигураций веб-сайтов. 
Кроме того, Nginx UI предоставляет такие функции, как онлайн-доступ к журналам Nginx, автоматическое тестирование и перезагрузка файлов конфигурации, веб-терминал. 

**Полезные ссылки:**
- [Документация Nginx](https://nginx.org/ru/docs/)
- [Утилита для тестирования конфига Gixy от яндекс](https://github.com/yandex/gixy)
